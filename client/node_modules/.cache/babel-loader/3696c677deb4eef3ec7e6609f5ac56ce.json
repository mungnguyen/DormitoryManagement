{"ast":null,"code":"// Load modules\nvar Boom = require('boom');\n\nvar Hoek = require('hoek');\n\nvar Cryptiles = require('cryptiles');\n\nvar Crypto = require('./crypto');\n\nvar Utils = require('./utils'); // Declare internals\n\n\nvar internals = {}; // Hawk authentication\n\n/*\n   req:                 node's HTTP request object or an object as follows:\n  \n                        var request = {\n                            method: 'GET',\n                            url: '/resource/4?a=1&b=2',\n                            host: 'example.com',\n                            port: 8080,\n                            authorization: 'Hawk id=\"dh37fgj492je\", ts=\"1353832234\", nonce=\"j4h3g2\", ext=\"some-app-ext-data\", mac=\"6R4rV5iE+NPoym+WwjeHzjAGXUtLNIxmo1vpMofpLAE=\"'\n                        };\n  \n   credentialsFunc:     required function to lookup the set of Hawk credentials based on the provided credentials id.\n                        The credentials include the MAC key, MAC algorithm, and other attributes (such as username)\n                        needed by the application. This function is the equivalent of verifying the username and\n                        password in Basic authentication.\n  \n                        var credentialsFunc = function (id, callback) {\n    \n                            // Lookup credentials in database\n                            db.lookup(id, function (err, item) {\n    \n                                if (err || !item) {\n                                    return callback(err);\n                                }\n    \n                                var credentials = {\n                                    // Required\n                                    key: item.key,\n                                    algorithm: item.algorithm,\n                                    // Application specific\n                                    user: item.user\n                                };\n    \n                                return callback(null, credentials);\n                            });\n                        };\n  \n   options: {\n\n        hostHeaderName:        optional header field name, used to override the default 'Host' header when used\n                               behind a cache of a proxy. Apache2 changes the value of the 'Host' header while preserving\n                               the original (which is what the module must verify) in the 'x-forwarded-host' header field.\n                               Only used when passed a node Http.ServerRequest object.\n  \n        nonceFunc:             optional nonce validation function. The function signature is function(nonce, ts, callback)\n                               where 'callback' must be called using the signature function(err).\n  \n        timestampSkewSec:      optional number of seconds of permitted clock skew for incoming timestamps. Defaults to 60 seconds.\n                               Provides a +/- skew which means actual allowed window is double the number of seconds.\n  \n        localtimeOffsetMsec:   optional local clock time offset express in a number of milliseconds (positive or negative).\n                               Defaults to 0.\n  \n        payload:               optional payload for validation. The client calculates the hash value and includes it via the 'hash'\n                               header attribute. The server always ensures the value provided has been included in the request\n                               MAC. When this option is provided, it validates the hash value itself. Validation is done by calculating\n                               a hash value over the entire payload (assuming it has already be normalized to the same format and\n                               encoding used by the client to calculate the hash on request). If the payload is not available at the time\n                               of authentication, the authenticatePayload() method can be used by passing it the credentials and\n                               attributes.hash returned in the authenticate callback.\n    }\n\n    callback: function (err, credentials, artifacts) { }\n */\n\nexports.authenticate = function (req, credentialsFunc, options, callback) {\n  // Default options\n  options.nonceFunc = options.nonceFunc || function (nonce, ts, callback) {\n    return callback();\n  }; // No validation\n\n\n  options.timestampSkewSec = options.timestampSkewSec || 60; // 60 seconds\n  // Application time\n\n  var now = Utils.now() + (options.localtimeOffsetMsec || 0); // Measure now before any other processing\n  // Convert node Http request object to a request configuration object\n\n  var request = Utils.parseRequest(req, options);\n\n  if (request instanceof Error) {\n    return callback(Boom.badRequest(request.message));\n  } // Parse HTTP Authorization header\n\n\n  var attributes = Utils.parseAuthorizationHeader(request.authorization);\n\n  if (attributes instanceof Error) {\n    return callback(attributes);\n  } // Construct artifacts container\n\n\n  var artifacts = {\n    method: request.method,\n    host: request.host,\n    port: request.port,\n    resource: request.url,\n    ts: attributes.ts,\n    nonce: attributes.nonce,\n    hash: attributes.hash,\n    ext: attributes.ext,\n    app: attributes.app,\n    dlg: attributes.dlg,\n    mac: attributes.mac,\n    id: attributes.id\n  }; // Verify required header attributes\n\n  if (!attributes.id || !attributes.ts || !attributes.nonce || !attributes.mac) {\n    return callback(Boom.badRequest('Missing attributes'), null, artifacts);\n  } // Fetch Hawk credentials\n\n\n  credentialsFunc(attributes.id, function (err, credentials) {\n    artifacts.credentials = credentials;\n\n    if (err) {\n      return callback(err, credentials || null, artifacts);\n    }\n\n    if (!credentials) {\n      return callback(Boom.unauthorized('Unknown credentials', 'Hawk'), null, artifacts);\n    }\n\n    if (!credentials.key || !credentials.algorithm) {\n      return callback(Boom.internal('Invalid credentials'), credentials, artifacts);\n    }\n\n    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {\n      return callback(Boom.internal('Unknown algorithm'), credentials, artifacts);\n    } // Calculate MAC\n\n\n    var mac = Crypto.calculateMac('header', artifacts);\n\n    if (!Cryptiles.fixedTimeComparison(mac, attributes.mac)) {\n      return callback(Boom.unauthorized('Bad mac', 'Hawk'), credentials, artifacts);\n    } // Check payload hash\n\n\n    if (options.payload !== null && options.payload !== undefined) {\n      // '' is valid\n      if (!attributes.hash) {\n        return callback(Boom.unauthorized('Missing required payload hash', 'Hawk'), credentials, artifacts);\n      }\n\n      var hash = Crypto.calculateHash(options.payload, credentials.algorithm, request.contentType);\n\n      if (!Cryptiles.fixedTimeComparison(hash, attributes.hash)) {\n        return callback(Boom.unauthorized('Bad payload hash', 'Hawk'), credentials, artifacts);\n      }\n    } // Check nonce\n\n\n    options.nonceFunc(attributes.nonce, attributes.ts, function (err) {\n      if (err) {\n        return callback(Boom.unauthorized('Invalid nonce', 'Hawk'), credentials, artifacts);\n      } // Check timestamp staleness\n\n\n      if (Math.abs(attributes.ts * 1000 - now) > options.timestampSkewSec * 1000) {\n        var fresh = Utils.now() + (options.localtimeOffsetMsec || 0); // Get fresh now\n\n        var tsm = Crypto.calculateTsMac(fresh, credentials);\n        return callback(Boom.unauthorized('Stale timestamp', 'Hawk', {\n          ts: fresh,\n          tsm: tsm\n        }), credentials, artifacts);\n      } // Successful authentication\n\n\n      return callback(null, credentials, artifacts);\n    });\n  });\n}; // Authenticate payload hash - used when payload cannot be provided during authenticate()\n\n/*\n    payload:        raw request payload\n    credentials:    from authenticate callback\n    hash:           from authenticate callback (artifacts.hash)\n    contentType:    req.headers['content-type']\n*/\n\n\nexports.authenticatePayload = function (payload, credentials, hash, contentType) {\n  var calculatedHash = Crypto.calculateHash(payload, credentials.algorithm, contentType);\n  return Cryptiles.fixedTimeComparison(calculatedHash, hash);\n}; // Generate a Server-Authorization header for a given response\n\n/*\n    artifacts: {}                                          // Object received from authenticate(); 'mac', 'hash', and 'ext' - ignored\n    options: {\n        ext: 'application-specific',                        // Application specific data sent via the ext attribute\n        payload: '{\"some\":\"payload\"}',                      // UTF-8 encoded string for body hash generation (ignored if hash provided)\n        contentType: 'application/json',                    // Payload content-type (ignored if hash provided)\n        hash: 'U4MKKSmiVxk37JCCrAVIjV='                     // Pre-calculated payload hash\n    }\n*/\n\n\nexports.header = function (artifacts, options) {\n  // Prepare inputs\n  options = options || {};\n\n  if (!artifacts || typeof artifacts !== 'object' || typeof options !== 'object') {\n    return '';\n  }\n\n  artifacts = Hoek.clone(artifacts);\n  delete artifacts.mac;\n  artifacts.hash = options.hash;\n  artifacts.ext = options.ext; // Validate credentials\n\n  var credentials = artifacts.credentials;\n\n  if (!credentials || !credentials.key || !credentials.algorithm) {\n    // Invalid credential object\n    return '';\n  }\n\n  if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {\n    return '';\n  } // Calculate payload hash\n\n\n  if (!artifacts.hash && options.hasOwnProperty('payload')) {\n    artifacts.hash = Crypto.calculateHash(options.payload, credentials.algorithm, options.contentType);\n  }\n\n  var mac = Crypto.calculateMac('response', artifacts); // Construct header\n\n  var header = 'Hawk mac=\"' + mac + '\"' + (artifacts.hash ? ', hash=\"' + artifacts.hash + '\"' : '');\n\n  if (artifacts.ext !== null && artifacts.ext !== undefined && artifacts.ext !== '') {\n    // Other falsey values allowed\n    header += ', ext=\"' + Utils.escapeHeaderAttribute(artifacts.ext) + '\"';\n  }\n\n  return header;\n};","map":null,"metadata":{},"sourceType":"script"}